name: Convert Subscription to Text Format

on:
  workflow_dispatch:
    inputs:
      subscription_url:
        description: '机场订阅链接（可选，与订阅内容二选一）'
        required: false
        type: string
      subscription_content:
        description: '订阅链接返回的 base64 内容（可选，与订阅链接二选一）'
        required: false
        type: string
      output_filename:
        description: '输出文件名（不含扩展名）'
        required: false
        default: 'sub_xfltd'
        type: string
  schedule:
    # 每天凌晨3点自动运行（可选，如果订阅链接在 secrets 中）
    - cron: '0 3 * * *'

env:
  OUTPUT_FILENAME: ${{ github.event.inputs.output_filename || 'sub_xfltd' }}

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Convert subscription to text format
      env:
        SUBSCRIPTION_URL: ${{ github.event.inputs.subscription_url || secrets.SUBSCRIPTION_URL }}
        SUBSCRIPTION_CONTENT: ${{ github.event.inputs.subscription_content }}
        OUTPUT_FILENAME: ${{ env.OUTPUT_FILENAME }}
      run: |
        if [ -n "$SUBSCRIPTION_CONTENT" ]; then
          python3 scripts/convert_subscription.py \
            --content "$SUBSCRIPTION_CONTENT" \
            --output "$OUTPUT_FILENAME"
        else
          python3 scripts/convert_subscription.py \
            --url "$SUBSCRIPTION_URL" \
            --output "$OUTPUT_FILENAME"
        fi

    - name: Display file statistics
      env:
        OUTPUT_FILENAME: ${{ env.OUTPUT_FILENAME }}
      run: |
        output_file="${OUTPUT_FILENAME}.txt"
        if [ -f "$output_file" ]; then
          echo "文件生成成功"
          echo "总行数: $(wc -l < "$output_file")"
          echo "文件大小: $(du -h "$output_file" | cut -f1)"
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: subscription-text
        path: ${{ env.OUTPUT_FILENAME }}.txt
        retention-days: 7

    - name: Check gist secrets
      id: check_gist
      run: |
        if [ -n "${{ secrets.GIST_TOKEN }}" ] && [ -n "${{ secrets.GIST_ID }}" ]; then
          echo "has_secrets=true" >> $GITHUB_OUTPUT
        else
          echo "has_secrets=false" >> $GITHUB_OUTPUT
        fi

    - name: Push to gist (optional)
      if: steps.check_gist.outputs.has_secrets == 'true'
      uses: exuanbo/actions-deploy-gist@v1
      with:
        token: ${{ secrets.GIST_TOKEN }}
        gist_id: ${{ secrets.GIST_ID }}
        file_path: ${{ env.OUTPUT_FILENAME }}.txt
        file_type: text

    - name: Output raw file URL
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "## 转换完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "文件已生成: \`${{ env.OUTPUT_FILENAME }}.txt\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "如果配置了 GIST_TOKEN 和 GIST_ID，文件已自动推送到 gist。" >> $GITHUB_STEP_SUMMARY
        echo "Gist 原始文件链接格式: \`https://gist.githubusercontent.com/USERNAME/GIST_ID/raw/${{ env.OUTPUT_FILENAME }}.txt\`" >> $GITHUB_STEP_SUMMARY
